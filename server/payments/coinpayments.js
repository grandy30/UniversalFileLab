const express=require('express');const router=express.Router();const Coinpayments=require('coinpayments');const crypto=require('crypto');const client=new Coinpayments({key:process.env.COINPAYMENTS_PUBLIC_KEY,secret:process.env.COINPAYMENTS_PRIVATE_KEY});router.post('/create',(req,res)=>{client.createTransaction({amount:req.body.amountUSD,currency1:'USD',currency2:process.env.COINPAYMENTS_CURRENCY||'USDT.TRC20',buyer_email:'buyer@local.test',item_name:'UniversalFileLab Premium',item_number:`UFL-${Date.now()}`},(err,result)=>{if(err)return res.status(500).json({error:err.message});res.json(result);});});router.post('/ipn',express.urlencoded({extended:false}),(req,res)=>{const hmac=req.headers['hmac'];const encoded=new URLSearchParams(req.body).toString();const mac=crypto.createHmac('sha512',process.env.COINPAYMENTS_IPN_SECRET||'').update(encoded).digest('hex');if(mac!==hmac){console.warn('bad hmac');return res.status(403).send('bad hmac')}console.log('IPN',req.body);res.send('OK')});module.exports=router;